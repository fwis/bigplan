<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babylon.js 虫子与草</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        #controlPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #controlPanel button, #controlPanel input, #controlPanel span {
            display: block;
            margin: 5px 0;
        }
        #miniMap {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid black;
            touch-action: none;
        }
        #trendChart {
            position: absolute;
            bottom: 10px;
            right: 220px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid black;
            touch-action: none;
        }
        #fpsDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.js"></script>
    <script src="camera.js"></script>
    <script src="world.js"></script>
    <script src="grass.js"></script>
    <script src="worm.js"></script>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="controlPanel">
        <input type="number" id="wormCount" value="100" placeholder="输入虫子数量" />
        <button id="addWorm">添加虫子</button>
        <input type="number" id="grassCount" value="100" placeholder="输入草的数量" />
        <button id="updateGrass">添加草</button>
        <span id="wormCountDisplay">虫子数量: 0</span>
        <span id="grassCountDisplay">草的数量: 0</span>
        <button id="toggleMovement">暂停虫子运动</button>
        <label for="speedControl">虫子速度</label>
        <input type="range" id="speedControl" min="0.01" max="1" step="0.01" value="0.05">
        <span id="speedDisplay">当前速度: 0.05</span>
        <label for="fpsInput">目标帧率</label>
        <input type="number" id="fpsInput" value="60" min="1" max="60" />
        <span id="fpsTargetDisplay">目标帧率: 60</span>
    </div>
    <canvas id="miniMap" width="200" height="200"></canvas>
    <canvas id="trendChart" width="500" height="200"></canvas>
    <div id="fpsDisplay">FPS: <span id="fpsValue">0</span></div>
    <script>
        // 获取canvas元素
        const canvas = document.getElementById("renderCanvas");
        const miniMapCanvas = document.getElementById("miniMap");
        const trendChart = document.getElementById("trendChart");
        const fpsDisplay = document.getElementById("fpsValue");
        const fpsInput = document.getElementById("fpsInput");
        const fpsTargetDisplay = document.getElementById("fpsTargetDisplay");

        // 创建Babylon引擎
        var engine = new BABYLON.Engine(canvas, true);
        var world = new World(1000, miniMapCanvas, trendChart);
        var camera = null;

        // 创建场景的函数
        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
            scene.collisionsEnabled = true;
            world.scene = scene;

            camera = new CustomCamera("customCamera", new BABYLON.Vector3(0, 100, 0), scene);
            camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
            camera.checkCollisions = true;
            camera.attachControl(canvas, false);

            var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
            light1.groundColor = new BABYLON.Color3(0.5, 0.5, 0.5);
            light1.specular = new BABYLON.Color3(0.3, 0.3, 0.3);
            light1.intensity = 1.0;

            var ground = BABYLON.MeshBuilder.CreateGround("ground", { width: world.WorldSize, height: world.WorldSize }, scene);
            var groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture("ground0.png", scene);
            groundMaterial.diffuseTexture.uScale = 50;
            groundMaterial.diffuseTexture.vScale = 50;
            ground.material = groundMaterial;
            ground.checkCollisions = true;

            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {
                width: world.WorldSize - 1,
                height: world.WorldSize * 3,
                depth: world.WorldSize - 1
            }, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBoxMaterial", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("https://www.babylonjs-playground.com/textures/skybox", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
            skybox.checkCollisions = false;

            world.LoadGrassModel("");
            world.LoadWormModel("worm2.glb");

            return scene;
        };

        // 添加虫子按钮事件
        document.getElementById("addWorm").addEventListener("click", function () {
            var count = parseInt(document.getElementById("wormCount").value) || 1;
            for (var i = 0; i < count; i++) {
                const x = Math.random() * world.WorldSize - world.WorldSize / 2;
                const z = Math.random() * world.WorldSize - world.WorldSize / 2;
                const rotation = Math.random() * Math.PI * 2 - Math.PI;
                world.CreateWorm(x, z, rotation);
            }
        });

        // 更新草数量按钮事件
        document.getElementById("updateGrass").addEventListener("click", function () {
            var count = parseInt(document.getElementById("grassCount").value) || 1;
            for (var i = 0; i < count; i++) {
                const x = Math.random() * world.WorldSize - world.WorldSize / 2;
                const z = Math.random() * world.WorldSize - world.WorldSize / 2;
                const rotation = Math.random() * Math.PI * 2 - Math.PI;

                const randomChoice = Math.random();
                if (randomChoice < 0.33) {
                    world.CreateSingleGrass(x, z, rotation);
                } else if (randomChoice < 0.66) {
                    world.CreateDenseGrass(x, z, rotation);
                } else {
                    world.CreateFlowerGrass(x, z, rotation);
                }
            }
        });

        // 暂停虫子运动按钮事件
        document.getElementById("toggleMovement").addEventListener("click", function () {
            world.ToggleWormMovement();
        });

        // 更新虫子速度事件
        document.getElementById("speedControl").addEventListener("input", function () {
            var speed = parseFloat(document.getElementById("speedControl").value);
            world.UpdateWormSpeed(speed);
            document.getElementById("speedDisplay").textContent = `当前速度: ${speed.toFixed(2)}`;
        });

        fpsInput.addEventListener("change", function () {
            var targetFPS = parseInt(fpsInput.value);
            fpsTargetDisplay.textContent = `目标帧率: ${targetFPS}`;
            adjustRenderLoop(targetFPS);
        });

        var scene = createScene();
        scene.registerBeforeRender(() => {
            const worldSize = world.WorldSize / 2 - 2;
            if (!camera || worldSize <= 0) return;
            const pos = camera.position;
            pos.x = Math.max(-worldSize, Math.min(worldSize, pos.x));
            pos.z = Math.max(-worldSize, Math.min(worldSize, pos.z));
        });

        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        let targetFPS = parseInt(fpsInput.value);
        let interval = 1000 / targetFPS;

        function adjustRenderLoop(newFPS) {
            targetFPS = newFPS;
            interval = 1000 / targetFPS;
        }

        function renderLoop() {
            const currentTime = performance.now();
            const delta = currentTime - lastTime;

            if (delta >= interval) {
                scene.render();
                world.RunFrame(fps);

                frameCount++;
                if (currentTime - lastTime >= 1000) {
                    fps = frameCount / ((currentTime - lastTime) / 1000);
                    fpsDisplay.textContent = fps.toFixed(2);
                    frameCount = 0;
                    lastTime = currentTime;
                }
                lastTime = currentTime;
            }

            requestAnimationFrame(renderLoop);
        }

        renderLoop();

        // 调整窗口大小时更新引擎大小
        window.addEventListener("resize", function () {
            engine.resize();
        });
</script>
</body>
</html>
